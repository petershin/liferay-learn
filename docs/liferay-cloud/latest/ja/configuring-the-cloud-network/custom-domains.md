# カスタムドメイン

Liferay Cloudでは、DNSプロバイダーを使ってカスタムドメインと環境サービスを接続することができます。

これを行うには、まずカスタムドメインを環境のロードバランサーのIPアドレスに登録します。 次に、Liferay Cloud コンソールまたはサービスの LCP.json ファイルを使用して、目的のサービスにドメインを追加します。

```{warning}
カスタムドメインへの変更や追加は、反映されるまでに最大60分かかることがあります。
```

* [環境IPを利用したカスタムドメインの登録](#registering-a-custom-domain-with-an-environment-ip)
* [Liferay Cloud Service にカスタムドメインを追加する](#adding-a-custom-domain-to-a-liferay-cloud-service)
* [カスタムドメインのステータスの確認](#verifying-the-status-of-a-custom-domain)

## 環境IPを利用したカスタムドメインの登録

各プロジェクト環境には独自のIngress Load Balancer IPがあり、カスタムドメインを環境サービスに接続するために使用することができます。

このIPは、各環境の **Network** のページと、各サービスの **カスタムドメイン** の専用ページに記載されています。

![図1：環境のIngress Load BalancerのIPは、環境のNetworkページで確認できます。](./custom-domains/images/01.png)

環境サービスにドメインを追加する前に、環境の専用IPを持つカスタムドメインをタイプ `A` レコードとして登録します。 これは、選択したドメイン名レジストラを使用して行います。

以下の例では、Cloudflareを使用してDNSレコードを作成しています。

![図2：この例では、Cloudflareをドメイン名レジストラとして使用し、DNSレコードを作成しています。](./custom-domains/images/02.png)

DNSの伝播が有効になるまでに24〜48時間かかることがありますが、場合によっては数分しかかからないこともあります。

この伝播プロセス中に、あるデバイスは更新されたアドレスのドメインに到達できる可能性がありますが、別のデバイスは到達できない可能性があります。 これは、デバイスがどのDNSサーバーに到達するかによって異なります。

準備ができると、ドメインはどのデバイスからも到達可能になり、Liferay Cloudのロードバランサーから標準の `デフォルトバックエンド - 404` エラーが返されるようになります。

## Liferay Cloud Service にカスタムドメインを追加する

ドメインが準備できたら、Liferay Cloud コンソールまたは `LCP.json` ファイルから環境のサービスに追加することができます。

```{important}
最大50のカスタムドメインを環境のサービスに追加することができます。
```

以下の手順で、Liferay Cloud コンソールから環境サービスにカスタムドメインを追加します。

1. 目的の環境に移動します。

1. カスタムドメインを追加するサービスを選択します。

1. ［**Custom Domains**］ タブをクリックします。

1. ご使用の環境に登録されているカスタムドメインを[**Domain Names** フィールドに入力します。

    ![図3：サービスの［カスタムドメイン］タブを使用してドメインを追加します。](./custom-domains/images/03.png)

1. ［**Update Custom Domains**］ をクリックして追加を確定します。

```{note}
Liferay Cloudのコンソールからカスタムドメインを追加すると、すべて [Let's Encrypt](https://letsencrypt.org/) が提供する証明書が自動的に使用されます。 カスタムドメインに [カスタムSSL証明書](./load-balancer.md#custom-ssl) を使用したい場合は、代わりにWebサーバーの `LCP.json` ファイルを介して追加する必要があります。
```

### LCP.jsonによるカスタムドメインの追加

`customDomains` プロパティをその環境の `LCP.json` ファイルに追加することで、その環境のサービスが使用するドメインを置き換えることができます。 特定の環境の `environments` 属性内にプロパティを追加します。

```json
{
    "id": "webserver",
    "environments":
    {
        "uat":
        {
            "loadBalancer":
            {
                "customDomains": ["acme.com", "www.acme.com"]
            }
        }
    } 
}
```

```{important}
追加したカスタムドメインごとに特定の環境を定義する必要があり、複数の環境で同じカスタムドメインを使用することはできません（異なる地域の[Disaster Recovery environments](../../troubleshooting/configuring-cross-region-disaster-recovery.md) は除きます）。 これは、Liferay Cloud が証明書を適切に生成し、ユーザーを正しいドメインにルーティングするために必要なものです。
```

カスタムドメインがサービスに追加され、変更がデプロイされると、Liferay Cloudがルーティングを処理します。

```{note}
カスタムドメインの数は、プロビジョニングプロセス中に設定されたクォータによって制限できます。 Liferay Cloudは、独自のロードバランサーを50のカスタムドメインに制限しています。
```

## カスタムドメインのステータスの確認

カスタムドメインのステータスは、以下の2つの方法で確認できます：

* ブラウザを開き、カスタムドメインを入力します。 エンドポイントの準備が整うと、 `default backend - 404` エラーやセキュリティ警告を返さなくなります。
* 環境の **ネットワーク** ページに移動し、Liferay Cloud コンソールからサービスのドメインの状態を確認します。

![図4：すべてのエンドポイントとカスタムドメインを［ネットワーク］ページに表示します。](./custom-domains/images/04.png)

バックエンドの処理により、設定後にカスタムドメインを確認できるようになるまでに時間がかかる場合があります。 カスタムドメインが検証可能になるまでの時間に影響を与えるバックエンドの処理は、Liferay Cloudのロードバランサーへのルート追加、 [Let's Encrypt](https://letsencrypt.org/) によるSSLサーバー証明書の要求、Let's Encryptからのチャレンジ受信、チャレンジ通過後のロードバランサーでの証明書の更新などです。

```{important}
チャレンジプロセス中にユーザーがドメインにアクセスしようとすると、ブラウザにセキュリティ警告が表示されますが、これは無視しても問題ありません。
```

バックエンドの処理が完了すると、Liferay CloudのロードバランサーにSSLサーバー証明書が更新され、サービスに到達可能でセキュアな状態になります。

[ロードバランサー](./load-balancer.md) を参照して、1つ以上のカスタムSSL証明書を設定する方法など、Liferay CloudのSSL証明書の詳細について確認してください。

## 関連トピック

* [ロードバランサー](./load-balancer.md)
* [LCP.jsonによる設定](../../reference/configuration-via-lcp-json.md)
